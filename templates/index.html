{% extends 'base.html' %}

{% block content %}
    <div class="container-fluid col-10 offset-1 p-2 border rounded text-center">
        <h1>Link shortener</h1>
        <form class="form-group" id='link_form' method="POST" novalidate>
            <label for="link_input">Link</label>
            <input id='link_input' name='link_input' maxlength="300" minlength="10" class="form-control" type="text">
            <button id="get_link" class="mt-1 btn btn-primary">Add</button>
            {% csrf_token %}
        </form>
    </div>
    <div id="link" class="container-fluid col-10 offset-1 border rounded text-center mt-2">
        Your link:  <a href="" id="link_text"></a>
    </div>

{% endblock %}

{% block script %}
    <script lang="javascript">
        $(document).ready(function() {

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var csrftoken = getCookie('csrftoken');

            $("#link").css("visibility", "hidden");

            $('#link_form').submit(function (e) {
                {#console.log('submiting form');#}
                e.preventDefault();
                $("#link").css("visibility", "hidden");

                var formdata = $("form#link_form").serializeArray();
                var data = {};
                $(formdata).each(function(index, obj){
                    data[obj.name] = obj.value;
                });

                {#console.log(data);#}
                $.ajax({
                   type: "POST",
                   url: $('form').action,
                   data: $('form').serialize(), // serializes the form's elements.
                   success: function(response) {
                       {#console.log(response); // show response from the script.#}
                       if (typeof response['error'] === "undefined") {
                           let price = response['price'];
                       }
                       let shortened = response['shortened_link'];
                       {#console.log(res);#}
                       $("#link_text").text("http://localhost:8888/shortener/" + shortened);
                       $("#link_text").attr("href", '/shortener/'+shortened);
                       $("#link").css("visibility", "visible");
                   }
                 });
            })

        });
    </script>
{% endblock %}